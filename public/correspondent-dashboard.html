<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Correspondent Dashboard</title>
<link rel="icon" href="crrengglogo.png" type="image/png"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(to right, #e0eafc, #cfdef3); display: flex; min-height: 100vh; color: #222; overflow-x: hidden; }
.sidebar { width: 250px; background: linear-gradient(180deg, #2C3E50, #34495E); padding: 20px; display: flex; flex-direction: column; position: fixed; top: 0; left: 0; bottom: 0; color: white; transition: all 0.3s ease; z-index: 100; }
.sidebar img { height: 50px; margin: 0 auto 15px auto; display: block; }
.sidebar h4 { text-align: center; margin-bottom: 30px; font-weight: bold; font-size: 16px; }
.menu a { display: block; color: white; text-decoration: none; padding: 12px; border-radius: 8px; margin: 8px 0; transition: all 0.3s ease; }
.menu a:hover, .menu .active { background: rgba(255,255,255,0.2); transform: translateX(5px); }
.logout { background-color: #E67E22; border: none; color: white; padding: 12px; border-radius: 20px; margin-top: auto; cursor: pointer; transition: background 0.3s ease; }
.logout:hover { background-color: #CA6F1E; }
.overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 90; transition: all 0.3s ease; }
.overlay.active { display: block; }
.mobile-toggle { display: none; position: fixed; top: 15px; left: 15px; background: #2C3E50; color: white; padding: 10px 15px; border-radius: 8px; cursor: pointer; z-index: 200; }
.main-content { margin-left: 250px; flex: 1; padding: 40px; transition: filter 0.3s ease; margin-top: 36px; }
.main-content.shifted { filter: blur(2px); pointer-events: none; }
h2 { text-align: center; margin-bottom: 30px; font-weight: bold; color: #2C3E50; }
.filters { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
.filters select { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; }
.card-box { background: white; border-radius: 18px; padding: 25px; text-align: center; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.15); margin: 10px; flex: 1 1 calc(25% - 20px); min-width: 250px; animation: fadeIn 0.6s ease forwards; }
.card-box:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
.circle-container { position: relative; width: 130px; height: 130px; margin: 0 auto; }
.circle-container canvas { position: absolute; top: 0; left: 0; }
.circle-container .percent-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 22px; font-weight: bold; color: #27AE60; }
.fail-text { margin-top: 12px; font-weight: bold; color: #E74C3C; }
.backlog-summary { display: flex; gap: 20px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
.summary-card { background: white; padding: 20px; border-radius: 15px; width: 250px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.15); transition: all 0.3s ease; animation: fadeIn 0.5s ease forwards; cursor: pointer; }
.summary-card:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 10px 20px rgba(0,0,0,0.25); }
.summary-card h3 { margin-bottom: 10px; font-size: 20px; }
.summary-card p { font-size: 18px; font-weight: bold; }
.summary-card.zero h3, .summary-card.zero p { color: #27AE60; }
.summary-card.low h3, .summary-card.low p { color: #F39C12; }
.summary-card.high h3, .summary-card.high p { color: #E74C3C; }
@keyframes fadeIn { from {opacity: 0; transform: translateY(20px);} to {opacity: 1; transform: translateY(0);} }
@media (max-width: 768px) { .main-content { margin-left: 0; padding: 20px; } .sidebar { left: -260px; } .sidebar.open { left: 0; } .mobile-toggle { display: block; } .filters { flex-direction: column; align-items: center; } }
</style>
</head>
<body>

<div class="overlay" id="overlay" onclick="toggleSidebar()"></div>
<div class="mobile-toggle" onclick="toggleSidebar()">‚ò∞ Menu</div>

<div class="sidebar" id="sidebar">
<img src="crrengglogo.png" alt="College Logo"/>
<h4 id="welcomeText">Welcome Correspondent</h4>
<div class="menu">
<a href="correspondent-dashboard.html" class="active">üè† Dashboard</a>
<a href="CRstudents.html">üéì Students</a>
<a href="CRfeesearch.html">üí∞ Fee Search</a>
<a href="CRbacklogsview.html">üìö Results</a>
<a href="CRmidmarks.html">üìù Mid Marks</a>
<a href="CRnotifications.html">üì¢ Send Notifications</a>
</div>
<button class="logout" onclick="logout()">Logout</button>
</div>

<div class="main-content" id="main-content">
<h2>Department Pass/Fail Statistics</h2>
<div class="filters">
<select id="deptSelect" onchange="fetchYears()" disabled></select>
<select id="yearSelect" onchange="fetchCourses()" disabled></select>
<select id="courseSelect" onchange="fetchSections()" disabled></select>
<select id="sectionSelect" onchange="fetchStats()" disabled></select>
</div>
<div id="statsContainer" class="d-flex flex-wrap justify-content-center"></div>

<h2 style="margin-top:40px;">Backlog Summary</h2>
<div class="backlog-summary" id="backlogSummary">
<div class="summary-card zero" onclick="fetchBacklogDetails('zero')"><h3>0 Backlogs</h3><p id="zeroBacklogs">0 Students</p></div>
<div class="summary-card low" onclick="fetchBacklogDetails('low')"><h3>1-2 Backlogs</h3><p id="lowBacklogs">0 Students</p></div>
<div class="summary-card high" onclick="fetchBacklogDetails('high')"><h3>3+ Backlogs</h3><p id="highBacklogs">0 Students</p></div>
</div>

<h2 style="margin-top:40px;">Backlog Students</h2>
<div class="text-center mb-3">
<button class="btn btn-danger" id="downloadPdfBtn" style="display:none;">‚¨á Download PDF</button>
</div>
<div id="backlogStudentsContainer" class="table-responsive"><p class="text-center text-secondary">No backlog students to display</p></div>

<h2 class="text-center mb-4">Subject-wise Backlogs</h2>
<div class="row mb-3">
<div class="col-md-4">
<label for="subjectSelect" class="form-label">Select Subject:</label>
<select id="subjectSelect" class="form-select" disabled><option value="">-- Choose Subject --</option></select>
</div>
<div class="col-md-2 d-flex align-items-end">
<button id="fetchSubjectBacklogsBtn" class="btn btn-primary w-100" disabled>Show Subject Backlogs</button>
</div>
</div>
<div id="subjectBacklogContainer" class="table-responsive mt-3" style="display: none;">
<table class="table table-bordered">
<thead><tr><th>Reg No</th><th>Name</th><th>Subject</th><th>Status</th></tr></thead>
<tbody id="subjectBacklogTableBody"></tbody>
</table>
<button class="btn btn-danger mt-3" id="downloadSubjectBacklogsPdf" style="display: none;">Download Subject Backlogs PDF</button>
</div>
<!-- ---------------- Subject PDF Download ---------------- -->
<div class="container mt-4">
  <h4>Download Total Backlog PDF</h4>
  <select id="subjectSelectPDF" class="form-select mb-2">
    <option value="">-- Select Subject --</option>
  </select>
  <button id="downloadBtn" class="btn btn-danger">Download PDF</button>
</div>

  
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.20/dist/sweetalert2.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<script>
const staffId = localStorage.getItem("userId");
const welcomeText = document.getElementById("welcomeText");

// ‚úÖ Login check
if (!staffId || staffId !== "correspondentcrre") {
  alert("Please login as Correspondent");
  window.location.href = "index.html";
} else {
  welcomeText.textContent = "Welcome Correspondent CRRE";
}

function logout() { localStorage.clear(); window.location.href="index.html"; }
function toggleSidebar() { document.getElementById("sidebar").classList.toggle("open"); document.getElementById("overlay").classList.toggle("active"); document.getElementById("main-content").classList.toggle("shifted"); }

function resetDropdown(id) { const el=document.getElementById(id); el.innerHTML=`<option value="">-- Select ${id.replace("Select","")} --</option>`; el.disabled=true; }
function clearStatsAndBacklogs() { document.getElementById("statsContainer").innerHTML=""; resetBacklogSummary(); }
function resetBacklogSummary() { document.getElementById("zeroBacklogs").innerText="0 Students"; document.getElementById("lowBacklogs").innerText="0 Students"; document.getElementById("highBacklogs").innerText="0 Students"; }

async function loadDepartments() {
try { const res=await fetch(`/principal/departments?staffId=${staffId}`); const depts=await res.json();
const deptSelect=document.getElementById("deptSelect"); deptSelect.disabled=false; deptSelect.innerHTML=`<option value="">-- Select Department --</option>`;
depts.forEach(d=>deptSelect.innerHTML+=`<option value="${d}">${d}</option>`); resetDropdown("yearSelect"); resetDropdown("courseSelect"); resetDropdown("sectionSelect"); clearStatsAndBacklogs();
} catch(err){ console.error(err); }
}
async function fetchYears() {
const dept=document.getElementById("deptSelect").value; if(!dept){ resetDropdown("yearSelect"); resetDropdown("courseSelect"); resetDropdown("sectionSelect"); clearStatsAndBacklogs(); return; }
const res=await fetch(`/principal/years?staffId=${staffId}&dept=${dept}`); const years=await res.json();
const yearSelect=document.getElementById("yearSelect"); yearSelect.disabled=false; yearSelect.innerHTML=`<option value="">-- Select Year --</option>`; years.forEach(y=>yearSelect.innerHTML+=`<option value="${y}">${y} Year</option>`); resetDropdown("courseSelect"); resetDropdown("sectionSelect"); clearStatsAndBacklogs();
}
async function fetchCourses() {
const dept=document.getElementById("deptSelect").value; const year=document.getElementById("yearSelect").value; if(!year){ resetDropdown("courseSelect"); resetDropdown("sectionSelect"); clearStatsAndBacklogs(); return; }
const res=await fetch(`/principal/courses?staffId=${staffId}&dept=${dept}&year=${year}`); const courses=await res.json();
const courseSelect=document.getElementById("courseSelect"); courseSelect.disabled=false; courseSelect.innerHTML=`<option value="">-- Select Course --</option>`; courses.forEach(c=>courseSelect.innerHTML+=`<option value="${c}">${c}</option>`); resetDropdown("sectionSelect"); clearStatsAndBacklogs();
}
async function fetchSections() {
const dept=document.getElementById("deptSelect").value; const year=document.getElementById("yearSelect").value;
const course=document.getElementById("courseSelect").value; if(!course){ resetDropdown("sectionSelect"); clearStatsAndBacklogs(); return; }
const res=await fetch(`/principal/sections?staffId=${staffId}&dept=${dept}&year=${year}&course=${encodeURIComponent(course)}`); const sections=await res.json();
const sectionSelect=document.getElementById("sectionSelect"); sectionSelect.disabled=false; sectionSelect.innerHTML=`<option value="">-- Select Section --</option>`; sections.forEach(sec=>sectionSelect.innerHTML+=`<option value="${sec}">Section ${sec}</option>`); clearStatsAndBacklogs();
}
async function fetchStats() {
const dept=document.getElementById("deptSelect").value; const year=document.getElementById("yearSelect").value; const course=document.getElementById("courseSelect").value; const section=document.getElementById("sectionSelect").value;
if(!dept || !year || !course || !section){ clearStatsAndBacklogs(); return; }
const res=await fetch(`/principal/pass-fail-stats?staffId=${staffId}&dept=${dept}&year=${year}&course=${encodeURIComponent(course)}&section=${section}`);
const data=await res.json(); const container=document.getElementById("statsContainer"); container.innerHTML="";
if(!data.stats || data.stats.length===0){ container.innerHTML=`<p class="text-center text-secondary">No data available</p>`; resetBacklogSummary(); return; }
data.stats.forEach((record,i)=>{ const card=document.createElement("div"); card.className="card-box";
card.innerHTML=`<h5>${record.course} - Section ${record.section}</h5>
<div class="circle-container"><canvas id="circle${i}" width="130" height="130"></canvas>
<div class="percent-text">${record.pass_percent}%</div></div>
<div class="fail-text">Fail: ${record.fail_percent}%</div>`; container.appendChild(card); drawCircle(`circle${i}`,record.pass_percent); });
fetchBacklogSummary(dept,year,course,section);
}
async function fetchBacklogSummary(dept,year,course,section){
const res=await fetch(`/principal/backlog-summary?staffId=${staffId}&dept=${dept}&year=${year}&course=${encodeURIComponent(course)}&section=${section}`);
const data=await res.json();
document.getElementById("zeroBacklogs").innerText=`${data.zero||0} Students`;
document.getElementById("lowBacklogs").innerText=`${data.low||0} Students`;
document.getElementById("highBacklogs").innerText=`${data.high||0} Students`;
}
async function fetchBacklogDetails(type){
const dept=document.getElementById("deptSelect").value; const year=document.getElementById("yearSelect").value;
const course=document.getElementById("courseSelect").value; const section=document.getElementById("sectionSelect").value;
if(!dept||!year||!course||!section){ document.getElementById("backlogStudentsContainer").innerHTML=`<p class="text-center text-secondary">Select filters to view backlog students</p>`; document.getElementById("downloadPdfBtn").style.display="none"; return; }
const res=await fetch(`/principal/backlog-details?staffId=${staffId}&dept=${dept}&year=${year}&course=${encodeURIComponent(course)}&section=${section}&type=${type}`);
const data=await res.json(); const container=document.getElementById("backlogStudentsContainer"); const pdfBtn=document.getElementById("downloadPdfBtn");
if(!data.students || data.students.length===0){ container.innerHTML=`<p class="text-center text-secondary">No backlog students found</p>`; pdfBtn.style.display="none"; return; }
let html=`<h4 class="mb-3">${type.toUpperCase()} Backlog Students</h4><table class="table table-bordered table-striped"><thead class="table-dark"><tr><th>Reg No</th><th>Subject Code</th><th>Subject Name</th><th>Grade</th></tr></thead><tbody>`;
data.students.forEach(stu=>{ if(stu.subjects.length===0){ html+=`<tr><td>${stu.reg_no}</td><td colspan="3" class="text-center">No Backlogs</td></tr>`; } else { stu.subjects.forEach(sub=>{ html+=`<tr><td>${stu.reg_no}</td><td>${sub.subcode}</td><td>${sub.subname}</td><td>${sub.grade}</td></tr>`; }); } });
html+=`</tbody></table>`; container.innerHTML=html; pdfBtn.style.display="inline-block";
pdfBtn.onclick=()=>downloadBacklogPDF(type);
}
async function downloadBacklogPDF(type){
const dept=document.getElementById("deptSelect").value; const year=document.getElementById("yearSelect").value;
const course=document.getElementById("courseSelect").value; const section=document.getElementById("sectionSelect").value;
const res=await fetch(`/principal/backlog-details?staffId=${staffId}&dept=${dept}&year=${year}&course=${encodeURIComponent(course)}&section=${section}&type=${type}`);
const data=await res.json(); const { jsPDF } = window.jspdf; const doc=new jsPDF();
doc.setFontSize(14); doc.text(`Backlog Report - ${type.toUpperCase()} Students`,14,15);
doc.text(`Dept: ${dept}, Year: ${year}, Course: ${course}, Section: ${section}`,14,25);
let rows=[]; data.students.forEach(stu=>{ if(stu.subjects.length===0) rows.push([stu.reg_no,"-","-","No Backlogs"]); else stu.subjects.forEach(sub=>rows.push([stu.reg_no,sub.subcode,sub.subname,sub.grade])); });
doc.autoTable({head:[['Reg No','Subject Code','Subject Name','Grade']],body:rows,startY:35,theme:'grid'}); doc.save(`Backlog_${type}_${dept}_${year}_${course}_${section}.pdf`);
}

async function loadSubjectsForSection() {
  const dept = document.getElementById("deptSelect").value;
  const year = document.getElementById("yearSelect").value;
  const course = document.getElementById("courseSelect").value;
  const section = document.getElementById("sectionSelect").value;

  const subjectSelect = document.getElementById("subjectSelect");
  subjectSelect.innerHTML = '<option value="">-- Choose Subject --</option>';
  subjectSelect.disabled = true;
  document.getElementById("fetchSubjectBacklogsBtn").disabled = true;

  if (!dept || !year || !course || !section) return;

  try {
    const res = await fetch(`/principal/subjects?staffId=${staffId}&dept=${dept}&year=${year}&course=${encodeURIComponent(course)}&section=${section}`);
    const subjects = await res.json(); // should be [{subcode, subname}, ...]
    if (subjects.length > 0) {
      subjects.forEach(sub => {
        const opt = document.createElement("option");
        opt.value = sub.subname;     // or sub.subcode if you prefer
        opt.textContent = sub.subname;
        subjectSelect.appendChild(opt);
      });
      subjectSelect.disabled = false;
      document.getElementById("fetchSubjectBacklogsBtn").disabled = false;
    }
  } catch (err) {
    console.error("Error loading subjects:", err);
  }
}

async function fetchSubjectBacklogs() {
  const dept = document.getElementById("deptSelect").value;
  const year = document.getElementById("yearSelect").value;
  const course = document.getElementById("courseSelect").value;
  const section = document.getElementById("sectionSelect").value;
  const subject = document.getElementById("subjectSelect").value;
  if (!subject) return;

  try {
    const res = await fetch(`/principal/subject-backlogs?staffId=${staffId}&dept=${dept}&year=${year}&course=${encodeURIComponent(course)}&section=${section}&subject=${encodeURIComponent(subject)}`);
    const students = await res.json(); // should return array of {regno, name, subcode, subname, grade}

    const tbody = document.getElementById("subjectBacklogTableBody");
    tbody.innerHTML = "";
    const container = document.getElementById("subjectBacklogContainer");
    const downloadBtn = document.getElementById("downloadSubjectBacklogsPdf");

    if (students.length > 0) {
      students.forEach(stu => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${stu.regno}</td><td>${stu.name || '-'}</td><td>${stu.subname}</td><td>${stu.grade}</td>`;
        tbody.appendChild(tr);
      });
      container.style.display = "block";
      downloadBtn.style.display = "inline-block";
    } else {
      tbody.innerHTML = `<tr><td colspan="4" class="text-center">No backlogs in ${subject}</td></tr>`;
      container.style.display = "block";
      downloadBtn.style.display = "none";
    }
  } catch (err) {
    console.error("Error fetching subject backlogs:", err);
  }
}

  // Load subjects when year changes
document.getElementById("yearSelect").addEventListener("change", async function() {
  const year = this.value;
  if (!year) return;

  const res = await fetch(`/principal/year-subjects?staffId=${staffId}&year=${year}`);
  const subjects = await res.json();

  const subjectSelect = document.getElementById("subjectSelect");
  subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
  subjects.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s.subname;
    opt.textContent = `${s.subcode} - ${s.subname}`;
    subjectSelect.appendChild(opt);
  });
});

// Fetch backlog students
async function fetchBacklogs() {
  const year = document.getElementById("yearSelect").value;
  const subject = document.getElementById("subjectSelect").value;
  if (!year || !subject) {
    alert("Please select year and subject");
    return;
  }

  const res = await fetch(`/principal/year-subject-backlogs?staffId=${staffId}&year=${year}&subject=${encodeURIComponent(subject)}`);
  backlogData = await res.json();

  const container = document.getElementById("backlogContainer");
  container.innerHTML = `
    <h5>Year: ${backlogData.year} | Subject: ${backlogData.subject} | Total Backlogs: ${backlogData.totalBacklogs}</h5>
    <table class="table table-bordered mt-3">
      <thead><tr><th>Reg No</th><th>Name</th><th>Subcode</th><th>Subname</th><th>Grade</th></tr></thead>
      <tbody>
        ${backlogData.students.map(s => `
          <tr>
            <td>${s.regno}</td>
            <td>${s.name}</td>
            <td>${s.subcode}</td>
            <td>${s.subname}</td>
            <td>${s.grade}</td>
          </tr>`).join("")}
      </tbody>
    </table>
  `;
}

// Download PDF
function downloadPDF() {
  if (!backlogData) {
    alert("Please fetch backlogs first");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(14);
  doc.text(`Backlog Report - ${backlogData.year}`, 14, 20);
  doc.text(`Subject: ${backlogData.subject}`, 14, 30);
  doc.text(`Total Backlogs: ${backlogData.totalBacklogs}`, 14, 40);

  let y = 50;
  backlogData.students.forEach((s, i) => {
    doc.text(`${i+1}. ${s.regno} - ${s.name} (${s.subcode})`, 14, y);
    y += 8;
    if (y > 270) { doc.addPage(); y = 20; }
  });

  doc.save(`backlogs_${backlogData.year}_${backlogData.subject}.pdf`);
}
document.getElementById("downloadSubjectBacklogsPdf").addEventListener("click",()=>{
const subject=document.getElementById("subjectSelect").value; const { jsPDF } = window.jspdf; const doc=new jsPDF();
doc.text(`Subject Backlogs Report - ${subject}`,14,16); doc.autoTable({ html:"#subjectBacklogContainer table", startY:20 }); doc.save(`subject_backlogs_${subject}.pdf`);
});

function drawCircle(id,percent){ const canvas=document.getElementById(id); const ctx=canvas.getContext("2d"); const radius=60; const startAngle=-0.5*Math.PI; const endAngle=(percent/100)*2*Math.PI+startAngle;
ctx.lineWidth=10; ctx.strokeStyle="#d6eaf8"; ctx.beginPath(); ctx.arc(radius,radius,radius-10,0,2*Math.PI); ctx.stroke();
ctx.strokeStyle="#27AE60"; ctx.beginPath(); ctx.arc(radius,radius,radius-10,startAngle,endAngle); ctx.stroke();
}

document.getElementById("fetchSubjectBacklogsBtn").addEventListener("click",fetchSubjectBacklogs);
document.getElementById("sectionSelect").addEventListener("change",loadSubjectsForSection);
loadDepartments();
async function loadSubjectsPDF() {
  try {
    const staffId = localStorage.getItem("userId");
    if (!staffId) throw new Error("Not logged in");

    const res = await fetch(`/principal/all-subjects?staffId=${staffId}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    const select = document.getElementById("subjectSelectPDF");
    select.innerHTML = '<option value="">-- Select Subject --</option>';

    if (!data.subjects || data.subjects.length === 0) {
      Swal.fire("Info", "No subjects found", "info");
      return;
    }

    data.subjects.forEach(sub => {
      const opt = document.createElement("option");
      opt.value = sub.subcode;
      opt.textContent = `${sub.subcode} - ${sub.subname}`;
      select.appendChild(opt);
    });

  } catch (err) {
    console.error("Failed to fetch subjects:", err);
    Swal.fire("Error", "Could not load subjects. Try refreshing the page.", "error");
  }
}

document.addEventListener("DOMContentLoaded", loadSubjectsPDF);
document.getElementById("downloadBtn").addEventListener("click", async () => {
  const staffId = localStorage.getItem("userId");
  const subcode = document.getElementById("subjectSelectPDF").value;

  if (!staffId) return Swal.fire("Error", "Please login again", "error");
  if (!subcode) return Swal.fire("Error", "Please select a subject", "warning");

  try {
    const res = await fetch(`/principal/backlog-pdf?staffId=${staffId}&subcode=${encodeURIComponent(subcode)}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const blob = await res.blob();

    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `backlog_${subcode}.pdf`;
    document.body.appendChild(a);
    a.click();
    a.remove();

  } catch (err) {
    console.error(err);
    Swal.fire("Error", "Failed to download PDF", "error");
  }
});

</script>
</body>
</html>
