<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Period Adjustment</title>
  <link rel="icon" href="crrengglogo.png" type="image/png" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
  />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
    
    :root {
      --primary-color: #0b1c3c; /* Deep Navy */
      --secondary-color: #1a3a60; /* Darker Blue */
      --accent-color: #ffcc5c; /* Gold/Amber */
      --background-start: #e9f0f9;
      --background-end: #f4f7f9;
      --background-light: #ffffff;
      --text-dark: #2c3e50;
      --text-light: #ecf0f1;
      --card-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      --border-radius-lg: 20px;
      --border-radius-md: 12px;
      --border-radius-sm: 8px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Roboto', sans-serif;
    }

    body {
      background: linear-gradient(135deg, var(--background-start) 0%, var(--background-end) 100%);
      color: var(--text-dark);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .container {
      max-width: 700px;
      margin: auto;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 25px;
      border-radius: var(--border-radius-lg);
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
    }

    .container:hover {
      box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
    }
    
    h2 {
      text-align: center;
      margin-bottom: 25px;
      color: var(--primary-color);
      font-weight: 500;
      font-size: 1.8em;
    }
    
    .form-row {
      display: flex;
      flex-direction: column;
      margin-bottom: 20px;
    }
    
    label {
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-dark);
      font-size: 1rem;
      transition: color 0.3s ease;
    }

    .form-row:hover label {
        color: var(--accent-color);
    }
    
    select, input[type="date"] {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius-md);
      font-size: 1rem;
      background-color: #f8f9fa;
      width: 100%;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    
    select:focus, input[type="date"]:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(11, 28, 60, 0.1);
    }

    select option[disabled] {
      color: #999;
    }
    
    button {
      background-color: var(--primary-color);
      color: var(--text-light);
      border: none;
      padding: 12px 20px;
      border-radius: var(--border-radius-md);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1rem;
      width: 100%;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    
    button:hover {
      background-color: var(--secondary-color);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
    }

    .back-button {
      background-color: #f1f1f1;
      color: var(--text-dark);
      margin-top: 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    
    .back-button:hover {
      background-color: #e0e0e0;
      transform: translateY(-2px);
    }

    /* SweetAlert2 Styling */
    .swal2-popup {
      font-family: 'Roboto', sans-serif;
      border-radius: var(--border-radius-md) !important;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2) !important;
    }
    .swal2-title, .swal2-html-container {
      color: var(--text-dark) !important;
    }
    .swal2-confirm {
      background-color: var(--primary-color) !important;
      color: var(--text-light) !important;
    }
    .swal2-cancel {
      background-color: var(--accent-color) !important;
      color: var(--text-dark) !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>🔄 Period Adjustment</h2>
    <form id="adjustForm">
      <div class="form-row">
        <label>Course:</label>
        <select id="courseSelect" required></select>
      </div>
      <div class="form-row">
        <label>Year:</label>
        <select id="yearSelect" required></select>
      </div>
      <div class="form-row">
        <label>Semester:</label>
        <select id="semesterSelect" required></select>
      </div>
      <div class="form-row">
        <label>Section:</label>
        <select id="sectionSelect" required></select>
      </div>
      <div class="form-row">
        <label>Day:</label>
        <select id="daySelect" required></select>
      </div>
      <div class="form-row">
        <label>Date:</label>
        <input type="date" id="adjustDate" required>
      </div>
      <div class="form-row">
        <label>Period:</label>
        <select id="periodSelect" required></select>
      </div>
      <div class="form-row">
        <label>Assign To (Staff):</label>
        <select id="staffSelect" required></select>
      </div>
      <div class="form-row">
        <label>Subject:</label>
        <select id="subjectSelect" required>
          <option value="">-- Select Subject --</option>
        </select>
      </div>
      <div class="form-row">
        <button type="submit">✅ Save Adjustment</button>
      </div>
      <div class="form-row">
        <button type="button" class="back-button" onclick="goBack()">🔙 Back</button>
      </div>
    </form>
  </div>
  <script>
    const staff_id = localStorage.getItem("staff_id");
    
    // Function to handle SweetAlert popups
    const showAlert = (icon, title, text) => {
      Swal.fire({
        icon,
        title,
        text,
        confirmButtonColor: 'var(--primary-color)'
      });
    };
    
    // Back button functionality
    const goBack = () => {
      window.location.href = "mark_attendance.html";
    };

    // Load staff allocation on page load
    window.onload = () => {
      fetch(`/api/staff-allocation?staff_id=${staff_id}`)
        .then(res => res.json())
        .then(data => {
          if (!data.length) {
            showAlert("info", "❌ No Allocation Found", "Contact admin.");
            return;
          }
          const unique = (arr, key) => [...new Set(arr.map(r => r[key]))];
          courseSelect.innerHTML = unique(data, "course").map(c => `<option>${c}</option>`).join('');
          yearSelect.innerHTML = unique(data, "year").map(y => `<option>${y}</option>`).join('');
          semesterSelect.innerHTML = unique(data, "semester").map(s => `<option>${s}</option>`).join('');
          sectionSelect.innerHTML = unique(data, "section").map(s => `<option>${s}</option>`).join('');
          daySelect.innerHTML = unique(data, "day").map(d => `<option>${d}</option>`).join('');
          
          const dropdowns = [courseSelect, yearSelect, semesterSelect, sectionSelect, daySelect, periodSelect];
          dropdowns.forEach(el => el.addEventListener("change", () => {
              if (el === daySelect) {
                  loadPeriods(data);
              }
              loadStaffList();
          }));
        })
        .catch(err => {
          console.error("Error fetching allocation:", err);
          showAlert("error", "❌ Error", "Failed to fetch allocation data. Please try again.");
        });
    };

    function loadPeriods(data) {
        const course = courseSelect.value.trim();
        const year = yearSelect.value.trim();
        const semester = semesterSelect.value.trim();
        const section = sectionSelect.value.trim();
        const day = daySelect.value.trim();
        const matches = data.filter(r =>
            r.course.trim() === course &&
            r.year.toString().trim() === year &&
            r.semester.toString().trim() === semester &&
            r.section.trim() === section &&
            r.day.trim() === day
        );
        let options = "";
        matches.forEach(m => {
            for (let i = 1; i <= 7; i++) {
                const sub = m[`period${i}`];
                if (sub) options += `<option value="${i}">${i}ᵗʰ Period - ${sub}</option>`;
            }
        });
        periodSelect.innerHTML = options || `<option disabled selected>No Periods</option>`;
        periodSelect.disabled = !options;
        loadStaffList();
    }
    
    function loadStaffList() {
      const course = courseSelect.value;
      const year = yearSelect.value;
      const semester = semesterSelect.value;
      const section = sectionSelect.value;
      const day = daySelect.value;
      const period_no = periodSelect.value;
      if (!course || !year || !semester || !section || !day || !period_no) {
        staffSelect.innerHTML = `<option disabled selected>-- Select all details first --</option>`;
        return;
      }
      fetch(`/api/staff-in-section?course=${course}&year=${year}&semester=${semester}&section=${section}&day=${day}&period=${period_no}`)
        .then(res => res.json())
        .then(staffs => {
          staffSelect.innerHTML = staffs
            .filter(s => s.staff_id !== staff_id)
            .map(s => s.busy
              ? `<option value="${s.staff_id}" disabled>${s.staff_name} (Busy)</option>`
              : `<option value="${s.staff_id}">${s.staff_name}</option>`
            )
            .join('');
        })
        .catch(err => {
          console.error("Error fetching staff:", err);
          showAlert("error", "❌ Error", "Failed to fetch staff list. Please try again.");
        });
    }

    staffSelect.addEventListener("change", () => {
      const staffId = staffSelect.value;
      if (!staffId) {
        subjectSelect.innerHTML = `<option value="">-- Select Subject --</option>`;
        return;
      }
      const course = courseSelect.value;
      const year = yearSelect.value;
      const semester = semesterSelect.value;
      const section = sectionSelect.value;
      fetch(`/api/staff-subjects?staff_id=${staffId}&course=${course}&year=${year}&semester=${semester}&section=${section}`)
        .then(res => res.json())
        .then(subjects => {
          if (subjects.length === 0) {
            subjectSelect.innerHTML = `<option value="">No subjects found</option>`;
            return;
          }
          subjectSelect.innerHTML = subjects
            .map(s => `<option value="${s.subject}">${s.subject}</option>`)
            .join('');
        })
        .catch(err => {
          console.error("Error fetching subjects:", err);
          showAlert("error", "❌ Error", "Failed to fetch subjects. Try again.");
        });
    });

    adjustForm.onsubmit = async (e) => {
      e.preventDefault();
      const payload = {
        from_staff_id: staff_id,
        to_staff_id: staffSelect.value,
        course: courseSelect.value,
        year: yearSelect.value,
        section: sectionSelect.value,
        semester: semesterSelect.value,
        day: daySelect.value,
        date: adjustDate.value,
        period_no: periodSelect.value,
        subject: subjectSelect.value
      };
      try {
        const res = await fetch("/api/adjust-period", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const result = await res.json();
        if (res.ok) {
          showAlert("success", "✅ Success", result.message || "Period adjustment saved successfully!");
          adjustForm.reset();
        } else {
          showAlert("error", "❌ Failed", result.error || "Unknown error occurred.");
        }
      } catch (err) {
        console.error("Submission error:", err);
        showAlert("error", "❌ Error", "Failed to save adjustment. Please check your connection and try again.");
      }
    };
  </script>
</body>
</html>
